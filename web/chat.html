<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI 聊天助手</title>
    <!-- Vue 3 -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <!-- Axios -->
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <!-- Marked.js for Markdown rendering -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <!-- Highlight.js for code highlighting -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@11.7.0/styles/github.min.css">
    <script src="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.7.0/build/highlight.min.js"></script>
    <style>
        /* 基础样式 */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background-color: #f5f5f5;
            color: #333;
            height: 100vh;
            overflow: hidden;
        }

        #app {
            height: 100vh;
        }

        .container {
            display: flex;
            height: 100%;
        }

        /* 侧边栏 */
        .sidebar {
            width: 320px;
            background-color: #fff;
            border-right: 1px solid #e0e0e0;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .header {
            padding: 20px;
            border-bottom: 1px solid #e0e0e0;
            background-color: #fafafa;
        }

        .header-content {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .home-link {
            text-decoration: none;
            display: inline-block;
        }

        .home-icon {
            width: 24px;
            height: 24px;
            opacity: 0.7;
            transition: opacity 0.2s;
        }

        .home-icon:hover {
            opacity: 1;
        }

        .header h2 {
            font-size: 18px;
            font-weight: 600;
            color: #333;
        }

        .model-selector {
            padding: 20px;
            border-bottom: 1px solid #e0e0e0;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .model-selector label {
            font-size: 14px;
            font-weight: 500;
            color: #555;
        }

        .model-selector select {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            background-color: #fff;
            color: #333;
            outline: none;
            transition: border-color 0.2s;
        }

        .model-selector select:focus {
            border-color: #4a90e2;
        }

        .model-selector button {
            padding: 10px 16px;
            background-color: #4a90e2;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .model-selector button:hover:not(:disabled) {
            background-color: #357ae8;
        }

        .model-selector button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }

        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            padding: 10px;
            border-top: 1px solid #e0e0e0;
        }

        .pagination button {
            padding: 5px 15px;
            border: 1px solid #007bff;
            background: #007bff;
            color: white;
            border-radius: 4px;
            cursor: pointer;
        }

        .pagination button:disabled {
            background: #ccc;
            border-color: #ccc;
            cursor: not-allowed;
        }

        .pagination span {
            color: #666;
        }

        /* 会话列表 */
        .sessions-list {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #888;
        }

        .empty-state h3 {
            font-size: 16px;
            margin-bottom: 8px;
        }

        .empty-state p {
            font-size: 14px;
        }

        .session-item {
            padding: 16px;
            margin-bottom: 12px;
            border-radius: 8px;
            border: 1px solid #e0e0e0;
            background-color: #fafafa;
            cursor: pointer;
            transition: all 0.2s;
        }

        .session-item:hover {
            border-color: #4a90e2;
            background-color: #f0f7ff;
        }

        .session-item.active {
            border-color: #4a90e2;
            background-color: #e3f2fd;
        }

        .session-title {
            font-size: 15px;
            font-weight: 500;
            margin-bottom: 6px;
            color: #333;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .session-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 13px;
            color: #666;
            margin-top: 4px;
        }

        .delete-session {
            padding: 4px 8px;
            background-color: #ff4444;
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .delete-session:hover {
            background-color: #cc0000;
        }

        /* 主内容区 */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            background-color: #fff;
            overflow: hidden;
        }

        /* 聊天容器 */
        .chat-container {
            flex: 1;
            overflow-y: auto;
            padding: 24px;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .message {
            display: flex;
        }

        .user-message {
            justify-content: flex-end;
        }

        .ai-message {
            justify-content: flex-start;
        }

        .message-bubble {
            max-width: 80%;
            padding: 16px 20px;
            border-radius: 18px;
            line-height: 1.5;
            word-wrap: break-word;
        }

        .user-bubble {
            background-color: #4a90e2;
            color: white;
            border-bottom-right-radius: 4px;
        }

        .ai-bubble {
            background-color: #f0f0f0;
            color: #333;
            border-bottom-left-radius: 4px;
        }

        .markdown-content {
            font-size: 15px;
        }

        .markdown-content p {
            margin-bottom: 10px;
        }

        .markdown-content pre {
            background-color: #f6f8fa;
            border-radius: 6px;
            padding: 16px;
            overflow-x: auto;
            margin: 10px 0;
        }

        .markdown-content code {
            font-family: 'Courier New', monospace;
            font-size: 14px;
        }

        .markdown-content h1,
        .markdown-content h2,
        .markdown-content h3 {
            margin-top: 16px;
            margin-bottom: 8px;
        }

        .markdown-content ul,
        .markdown-content ol {
            padding-left: 24px;
            margin-bottom: 10px;
        }

        .cursor {
            display: inline-block;
            width: 8px;
            height: 18px;
            background-color: #333;
            margin-left: 2px;
            animation: blink 1s infinite;
        }

        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0; }
        }

        .typing-indicator {
            padding: 16px 20px;
            background-color: #f0f0f0;
            border-radius: 18px;
            color: #666;
            font-style: italic;
        }

        /* 输入区域 */
        .input-container {
            padding: 20px;
            border-top: 1px solid #e0e0e0;
            background-color: #fafafa;
        }

        .input-group {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .file-upload-area {
            display: flex;
            align-items: center;
            gap: 12px;
            flex-wrap: wrap;
        }

        .file-upload-area button {
            padding: 8px 16px;
            background-color: #6c757d;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .file-upload-area button:hover:not(:disabled) {
            background-color: #545b62;
        }

        .file-upload-area button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }

        .file-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .file-item {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 6px 10px;
            background-color: #e9ecef;
            border-radius: 4px;
            font-size: 13px;
        }

        .file-name {
            max-width: 200px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .remove-file {
            background: none;
            border: none;
            color: #dc3545;
            font-size: 16px;
            cursor: pointer;
            padding: 0 2px;
        }

        .remove-file:hover {
            color: #a71d2a;
        }

        textarea {
            width: 100%;
            padding: 16px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 15px;
            font-family: inherit;
            resize: none;
            outline: none;
            transition: border-color 0.2s;
        }

        textarea:focus {
            border-color: #4a90e2;
        }

        textarea:disabled {
            background-color: #f5f5f5;
            color: #999;
        }

        .button-group {
            display: flex;
            justify-content: flex-end;
        }

        .button-group button {
            padding: 12px 24px;
            background-color: #4a90e2;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 15px;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .button-group button:hover:not(:disabled) {
            background-color: #357ae8;
        }

        .button-group button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
    </style>
</head>
<body>
    <div id="app">
        <div class="container">
            <!-- 左侧边栏 -->
            <div class="sidebar">
                <div class="header">
                    <div class="header-content">
                        <a href="/" class="home-link">
                            <img src="/static/picture/main.svg" alt="主页" class="home-icon">
                        </a>
                        <h2>AI 聊天助手</h2>
                    </div>
                </div>

                <div class="model-selector">
                    <label for="model-select">选择模型:</label>
                    <select id="model-select" v-model="selectedModel">
                        <option value="">请选择模型</option>
                        <option v-for="model in models" :key="model.Name" :value="model.Name">
                            {{ model.Name }} ({{ model.ModelKind }})
                        </option>
                    </select>
                    <label for="persona-select">选择人格:</label>

                    <select id="persona-select" v-model="selectedPersona">
                        <option value="">默认助手</option>
                        <option v-for="persona in personas" :key="persona" :value="persona">
                            {{ persona }}
                        </option>
                    </select>

                    <button @click="createNewSession" :disabled="!selectedModel">新会话</button>
                </div>

                <div class="pagination" v-if="totalPages > 0">
                    <button @click="previousPage" :disabled="currentPage <= 1">上一页</button>
                    <span>第 {{ currentPage }} / {{ totalPages }} 页 (共 {{ totalSessions }} 个会话)</span>
                    <button @click="nextPage" :disabled="currentPage >= totalPages">下一页</button>
                </div>

                <div class="sessions-list">
                    <div v-if="sessions.length === 0" class="empty-state">
                        <h3>暂无会话</h3>
                        <p>选择一个模型并创建新会话开始聊天</p>
                    </div>
                    <div
                        v-for="session in sessions"
                        :key="session.SessionID"
                        :class="['session-item', session.SessionID === sessionId ? 'active' : '']"
                        @click="switchSession(session)"
                    >
                        <div class="session-title">{{ session.Title || '新对话' }}</div>
                        <div class="session-meta">
                            <span>{{ session.MessageCount }} 条消息</span>
                            <span>{{ formatDate(session.UpdatedAt) }}</span>
                        </div>
                        <div class="session-meta">
                            <span>模型: {{ session.ModelName }}</span>
                            <button
                                class="delete-session"
                                @click.stop="deleteSession(session.SessionID)"
                                title="删除会话"
                            >
                                删除
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 右侧主内容区 -->
            <div class="main-content">
                <!-- 消息显示部分 -->
                <div class="chat-container" ref="chatContainer">
                    <div v-if="sessionId && messages.length === 0" class="empty-state">
                        <h3>开始对话</h3>
                        <p>在下方输入消息开始与AI对话</p>
                    </div>
                    <div v-for="message in messages" :key="message.id"
                         :class="['message', message.role === 'user' ? 'user-message' : 'ai-message']">
                        <div :class="['message-bubble', message.role === 'user' ? 'user-bubble' : 'ai-bubble']">
                            <!-- 用户消息保持原样显示 -->
                            <template v-if="message.role === 'user'">
                                <span style="white-space: pre-wrap;">{{ message.content }}</span>
                            </template>
                            <!-- AI 消息使用 Markdown 渲染 -->
                            <template v-else>
                                <div class="markdown-content" v-html="renderMarkdown(message.content)"></div>
                            </template>
                            <span v-if="message.streaming" class="cursor"></span>
                        </div>
                    </div>
                    <div v-if="isTyping" class="message ai-message">
                        <div class="typing-indicator">AI 正在思考<span class="cursor"></span></div>
                    </div>
                </div>

                <div class="input-container">
                    <div class="input-group">
                        <!-- 文件上传区域 -->
                        <div class="file-upload-area">
                            <input type="file" ref="fileInput" multiple
                                   accept=".txt,.py,.go,.c,.cpp,.h,.hpp,.js,.ts,.java,.html,.css,.md,.json,.xml,.yaml,.yml"
                                   @change="handleFileUpload" style="display: none">
                            <button type="button" @click="triggerFileInput" :disabled="!sessionId || isTyping">
                                选择文件
                            </button>
                            <div class="file-list" v-if="uploadedFiles.length > 0">
                                <div v-for="file in uploadedFiles" :key="file.id" class="file-item">
                                    <span class="file-name">{{ file.name }}</span>
                                    <button type="button" @click="removeFile(file)" class="remove-file">×</button>
                                </div>
                            </div>
                        </div>

                        <textarea
                            v-model="inputMessage"
                            placeholder="输入你的消息... (按 Ctrl+Enter 发送)"
                            @keydown.ctrl.enter="sendMessage"
                            :disabled="!sessionId || isTyping"
                            rows="3"
                        ></textarea>
                        <div class="button-group">
                            <button
                                @click="sendMessage"
                                :disabled="!inputMessage && uploadedFiles.length === 0 || !sessionId || isTyping">
                                发送
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const { createApp, ref, onMounted, nextTick } = Vue;

        createApp({
            setup() {
                const models = ref([]);
                const sessions = ref([]);
                const selectedModel = ref('');
                const sessionId = ref('');
                const messages = ref([]);
                const inputMessage = ref('');
                const isTyping = ref(false);
                const chatContainer = ref(null);
                const personas = ref([]);
                const selectedPersona = ref('');
                const uploadedFiles = ref([]);
                const fileInput = ref(null);

                const API_BASE = '/api';

                // 配置 Marked 和 Highlight.js
                const configureMarkdown = () => {
                    // 配置 marked 选项
                    marked.setOptions({
                        highlight: function(code, lang) {
                            const language = hljs.getLanguage(lang) ? lang : 'plaintext';
                            return hljs.highlight(code, { language }).value;
                        },
                        langPrefix: 'hljs language-',
                        pedantic: false,
                        gfm: true,
                        breaks: true,
                        sanitize: false,
                        smartLists: true,
                        smartypants: false,
                        xhtml: false
                    });

                    // 配置 highlight.js
                    hljs.configure({
                        tabReplace: '    ', // 4 spaces
                        classPrefix: 'hljs-',
                        languages: ['javascript', 'python', 'java', 'go', 'c', 'cpp', 'html', 'css', 'json', 'xml', 'bash', 'sql', 'markdown']
                    });
                };

                // Markdown 渲染函数
                const renderMarkdown = (content) => {
                    try {
                        return marked.parse(content);
                    } catch (error) {
                        console.error('Markdown 渲染错误:', error);
                        return content; // 如果渲染失败，返回原始内容
                    }
                };

                const triggerFileInput = () => {
                    console.log('触发文件选择');
                    if (fileInput.value) {
                        fileInput.value.click();
                    } else {
                        console.error('fileInput 未找到');
                    }
                };

                const handleFileUpload = (event) => {
                    console.log('文件选择变化', event.target.files);
                    const files = Array.from(event.target.files);
                    files.forEach(file => {
                        // 检查文件类型
                        const allowedTypes = ['.txt', '.py', '.go', '.c', '.cpp', '.h', '.hpp', '.js', '.ts', '.java', '.html', '.css', '.md', '.json', '.xml', '.yaml', '.yml'];
                        const fileExt = '.' + file.name.split('.').pop().toLowerCase();

                        if (!allowedTypes.includes(fileExt)) {
                            alert(`不支持的文件类型: ${fileExt}`);
                            return;
                        }

                        // 检查文件大小（限制为5MB）
                        if (file.size > 5 * 1024 * 1024) {
                            alert(`文件太大: ${file.name}，请选择小于5MB的文件`);
                            return;
                        }

                        uploadedFiles.value.push({
                            id: Date.now() + Math.random(),
                            file: file,
                            name: file.name,
                            size: file.size,
                            type: file.type
                        });
                    });

                    // 清空input以便选择相同文件
                    event.target.value = '';
                };

                const removeFile = (fileToRemove) => {
                    uploadedFiles.value = uploadedFiles.value.filter(file => file.id !== fileToRemove.id);
                };

                const uploadFiles = async (sessionID) => {
                    const fileIDs = [];

                    for (const fileInfo of uploadedFiles.value) {
                        const formData = new FormData();
                        formData.append('file', fileInfo.file);
                        formData.append('session_id', sessionID);

                        try {
                            const response = await axios.post(`${API_BASE}/files/upload`, formData, {
                                headers: {
                                    'Content-Type': 'multipart/form-data'
                                }
                            });

                            if (response.data.file_id) {
                                fileIDs.push(response.data.file_id);
                            }
                        } catch (error) {
                            console.error('文件上传失败:', error);
                            alert(`文件上传失败: ${fileInfo.name}`);
                        }
                    }

                    return fileIDs;
                };

                // 获取模型列表 - 修改为从用户API中获取唯一模型
                const fetchModels = async () => {
                    try {
                        const response = await axios.get(`${API_BASE}/user/apis`);
                        const apis = response.data.apis || [];
                        // 提取唯一的 model_name
                        const uniqueModels = {};
                        apis.forEach(api => {
                            if (api.model_name && !uniqueModels[api.model_name]) {
                                uniqueModels[api.model_name] = {
                                    Name: api.model_name,
                                    ModelKind: 'API'
                                };
                            }
                        });
                        models.value = Object.values(uniqueModels);
                        // 如果有模型，默认选择第一个
                        if (models.value.length > 0 && !selectedModel.value) {
                            selectedModel.value = models.value[0].Name;
                        }
                    } catch (error) {
                        console.error('获取模型列表失败:', error);
                    }
                };

                // 添加分页状态
                const currentPage = ref(1);
                const pageSize = ref(20);
                const totalSessions = ref(0);
                const totalPages = ref(0);

                // 获取会话列表
                const fetchSessions = async (page = 1) => {
                    try {
                        const response = await axios.get(`${API_BASE}/chat/sessions`, {
                            params: {
                                page: page,
                                page_size: pageSize.value
                            }
                        });

                        sessions.value = response.data.data;

                        // 处理分页信息
                        if (response.data.pagination) {
                            currentPage.value = response.data.pagination.page;
                            pageSize.value = response.data.pagination.page_size;
                            totalSessions.value = response.data.pagination.total;
                            totalPages.value = response.data.pagination.total_pages;
                        }
                    } catch (error) {
                        console.error('获取会话列表失败:', error);
                    }
                };

                // 上一页
                const previousPage = () => {
                    if (currentPage.value > 1) {
                        fetchSessions(currentPage.value - 1);
                    }
                };

                // 下一页
                const nextPage = () => {
                    if (currentPage.value < totalPages.value) {
                        fetchSessions(currentPage.value + 1);
                    }
                };

                // 跳转到指定页
                const goToPage = (page) => {
                    if (page >= 1 && page <= totalPages.value) {
                        fetchSessions(page);
                    }
                };

                // 获取特定会话的消息
                const fetchSessionMessages = async (sessionID) => {
                    try {
                        const response = await axios.get(`${API_BASE}/chat/sessions/${sessionID}/messages`);
                        return response.data.data;
                    } catch (error) {
                        console.error('获取会话消息失败:', error);
                        return [];
                    }
                };

                // 创建新会话
                const createNewSession = async () => {
                    if (!selectedModel.value) return;

                    try {
                        const response = await axios.post(`${API_BASE}/chat/session`, {
                            model_name: selectedModel.value,
                            persona: selectedPersona.value
                        });

                        sessionId.value = response.data.session_id;
                        messages.value = [];

                        // 刷新会话列表
                        await fetchSessions();
                        console.log('新会话创建成功:', sessionId.value);
                    } catch (error) {
                        console.error('创建会话失败:', error);
                        alert('创建会话失败: ' + (error.response?.data?.error || error.message));
                    }
                };

                // 切换会话
                const switchSession = async (session) => {
                    if (session.SessionID === sessionId.value) return;

                    sessionId.value = session.SessionID;
                    selectedModel.value = session.ModelName;

                    // 加载该会话的消息
                    const sessionMessages = await fetchSessionMessages(session.SessionID);
                    messages.value = sessionMessages.map((msg, index) => ({
                        id: Date.now() + index,
                        role: msg.role,
                        content: msg.content,
                        streaming: false
                    }));

                    scrollToBottom();
                };

                // 删除会话
                const deleteSession = async (sessionID) => {
                    if (!confirm('确定要删除这个会话吗？此操作不可恢复。')) {
                        return;
                    }

                    try {
                        await axios.delete(`${API_BASE}/chat/sessions/${sessionID}`);

                        // 如果删除的是当前会话，清空当前会话
                        if (sessionID === sessionId.value) {
                            sessionId.value = '';
                            messages.value = [];
                        }

                        // 刷新会话列表
                        await fetchSessions();
                    } catch (error) {
                        console.error('删除会话失败:', error);
                        alert('删除会话失败: ' + (error.response?.data?.error || error.message));
                    }
                };

                // 发送消息（流式版本）- 修正SSE解析
                const sendMessage = async () => {
                    if ((!inputMessage.value.trim() && uploadedFiles.value.length === 0) || !sessionId.value || isTyping.value) return;

                    const userMessage = inputMessage.value.trim();

                    // 上传文件并获取文件ID
                    let fileIDs = [];
                    if (uploadedFiles.value.length > 0) {
                        fileIDs = await uploadFiles(sessionId.value);
                    }

                    inputMessage.value = '';

                    // 添加用户消息到界面
                    messages.value.push({
                        id: Date.now(),
                        role: 'user',
                        content: userMessage + (uploadedFiles.value.length > 0 ? ` [附件: ${uploadedFiles.value.map(f => f.name).join(', ')}]` : ''),
                        streaming: false
                    });

                    scrollToBottom();
                    isTyping.value = true;

                    // 创建AI消息项，初始内容为空
                    const aiMessageId = Date.now() + 1;
                    const aiMessage = {
                        id: aiMessageId,
                        role: 'assistant',
                        content: '',
                        streaming: true
                    };
                    messages.value.push(aiMessage);

                    scrollToBottom();

                    try {
                        const response = await fetch(`${API_BASE}/chat/message/stream`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                session_id: sessionId.value,
                                model_name: selectedModel.value,
                                message: userMessage,
                                persona: selectedPersona.value,
                                file_ids: fileIDs  // 添加文件ID
                            })
                        });

                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }

                        const reader = response.body.getReader();
                        const decoder = new TextDecoder();

                        // 用于累积不完整的数据
                        let buffer = '';

                        while (true) {
                            const { value, done } = await reader.read();
                            if (done) break;

                            // 解码并添加到缓冲区
                            buffer += decoder.decode(value, { stream: true });

                            // 按行分割
                            const lines = buffer.split('\n');
                            // 保留最后一行（可能不完整）
                            buffer = lines.pop() || '';

                            for (const line of lines) {
                                if (line.startsWith('data: ')) {
                                    const dataStr = line.slice(6);
                                    if (dataStr.trim() === '') continue;

                                    try {
                                        const data = JSON.parse(dataStr);

                                        if (data.content !== undefined) {
                                            // 更新AI消息内容
                                            const aiMsg = messages.value.find(msg => msg.id === aiMessageId);
                                            if (aiMsg) {
                                                aiMsg.content += data.content;
                                            }
                                            scrollToBottom();
                                        }

                                        if (data.done) {
                                            // 流式传输完成
                                            const aiMsg = messages.value.find(msg => msg.id === aiMessageId);
                                            if (aiMsg) {
                                                aiMsg.streaming = false;
                                            }
                                            break;
                                        }

                                        if (data.error) {
                                            throw new Error(data.error);
                                        }
                                    } catch (e) {
                                        console.error('解析SSE数据失败:', e, '数据:', dataStr);
                                    }
                                }
                            }
                        }

                        // 清空已上传文件列表
                        uploadedFiles.value = [];
                        // 刷新会话列表以更新消息计数和最后更新时间
                        await fetchSessions();
                    } catch (error) {
                        console.error('发送消息失败:', error);
                        // 更新AI消息为错误信息
                        const aiMsg = messages.value.find(msg => msg.id === aiMessageId);
                        if (aiMsg) {
                            aiMsg.content = '抱歉，发生了错误: ' + error.message;
                            aiMsg.streaming = false;
                        }
                        scrollToBottom();
                    } finally {
                        isTyping.value = false;
                    }
                };

                // 格式化日期
                const formatDate = (dateString) => {
                    const date = new Date(dateString);
                    const now = new Date();
                    const diffMs = now - date;
                    const diffMins = Math.floor(diffMs / (1000 * 60));
                    const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
                    const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));

                    if (diffMins < 1) return '刚刚';
                    if (diffMins < 60) return `${diffMins}分钟前`;
                    if (diffHours < 24) return `${diffHours}小时前`;
                    if (diffDays < 7) return `${diffDays}天前`;

                    return date.toLocaleDateString();
                };

                // 滚动到底部
                const scrollToBottom = () => {
                    nextTick(() => {
                        if (chatContainer.value) {
                            chatContainer.value.scrollTop = chatContainer.value.scrollHeight;
                        }
                    });
                };

                const fetchPersonas = async () => {
                    try {
                        const response = await axios.get(`${API_BASE}/personas`);
                        personas.value = response.data.data;
                    } catch (error) {
                        console.error('获取人格列表失败:', error);
                    }
                };

                onMounted(() => {
                    fetchModels();
                    fetchSessions();
                    fetchPersonas();
                    configureMarkdown();
                    // 调试：检查fileInput是否正确绑定
                    console.log('fileInput ref:', fileInput.value);
                });

                return {
                    models,
                    sessions,
                    selectedModel,
                    sessionId,
                    messages,
                    inputMessage,
                    isTyping,
                    chatContainer,
                    createNewSession,
                    switchSession,
                    deleteSession,
                    sendMessage,
                    formatDate,
                    personas,
                    selectedPersona,
                    uploadedFiles,
                    fileInput,
                    triggerFileInput,
                    handleFileUpload,
                    removeFile,
                    renderMarkdown,
                    currentPage,
                    pageSize,
                    totalSessions,
                    totalPages,
                    previousPage,
                    nextPage,
                    goToPage
                };
            }
        }).mount('#app');
    </script>
</body>
</html>